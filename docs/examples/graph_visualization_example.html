<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEGIS RAG - Graph Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            text-align: center;
        }

        #controls {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #controls label {
            margin-right: 10px;
            font-weight: bold;
        }

        #controls input, #controls select, #controls button {
            margin-right: 15px;
            padding: 5px 10px;
        }

        #graph-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
            z-index: 1000;
        }

        .node {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
        }

        .node:hover {
            stroke: #ffa500;
            stroke-width: 3px;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .link-label {
            font-size: 10px;
            fill: #666;
            text-anchor: middle;
        }

        .node-label {
            font-size: 12px;
            pointer-events: none;
            text-anchor: middle;
            fill: #333;
        }

        #metadata {
            background: white;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>AEGIS RAG - Knowledge Graph Visualization</h1>

    <div id="controls">
        <label for="entityId">Entity ID:</label>
        <input type="text" id="entityId" placeholder="entity_1" value="entity_1">

        <label for="depth">Depth:</label>
        <select id="depth">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
        </select>

        <label for="maxNodes">Max Nodes:</label>
        <select id="maxNodes">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
        </select>

        <button onclick="loadGraph()">Load Graph</button>
        <button onclick="resetZoom()">Reset Zoom</button>
    </div>

    <div id="graph-container">
        <svg id="graph" width="1200" height="800"></svg>
        <div id="tooltip"></div>
    </div>

    <div id="metadata"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';

        // D3.js visualization setup
        const width = 1200;
        const height = 800;
        const svg = d3.select('#graph');
        const tooltip = d3.select('#tooltip');

        // Create groups for links and nodes
        const g = svg.append('g');
        const linkGroup = g.append('g').attr('class', 'links');
        const nodeGroup = g.append('g').attr('class', 'nodes');
        const labelGroup = g.append('g').attr('class', 'labels');

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Color scale for node types
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        // Force simulation
        let simulation = d3.forceSimulation()
            .force('link', d3.forceLink().id(d => d.id).distance(100))
            .force('charge', d3.forceManyBody().strength(-300))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(30));

        async function loadGraph() {
            const entityId = document.getElementById('entityId').value;
            const depth = document.getElementById('depth').value;
            const maxNodes = document.getElementById('maxNodes').value;

            if (!entityId) {
                alert('Please enter an entity ID');
                return;
            }

            try {
                // Show loading state
                document.getElementById('metadata').innerHTML = '<p>Loading graph...</p>';

                // Fetch graph data from API
                const url = `${API_BASE_URL}/graph/visualize/${entityId}?depth=${depth}&max_nodes=${maxNodes}&format=d3`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                visualizeGraph(result.data, result.metadata);

            } catch (error) {
                console.error('Error loading graph:', error);
                document.getElementById('metadata').innerHTML =
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function visualizeGraph(data, metadata) {
            // Clear existing graph
            linkGroup.selectAll('*').remove();
            nodeGroup.selectAll('*').remove();
            labelGroup.selectAll('*').remove();

            // Create links
            const link = linkGroup.selectAll('line')
                .data(data.links)
                .join('line')
                .attr('class', 'link')
                .attr('stroke-width', d => Math.sqrt(d.value));

            // Create nodes
            const node = nodeGroup.selectAll('circle')
                .data(data.nodes)
                .join('circle')
                .attr('class', 'node')
                .attr('r', 10)
                .attr('fill', d => colorScale(d.group))
                .call(drag(simulation))
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', nodeClick);

            // Create labels
            const label = labelGroup.selectAll('text')
                .data(data.nodes)
                .join('text')
                .attr('class', 'node-label')
                .attr('dy', -15)
                .text(d => d.label.length > 20 ? d.label.substring(0, 20) + '...' : d.label);

            // Update force simulation
            simulation
                .nodes(data.nodes)
                .on('tick', ticked);

            simulation.force('link')
                .links(data.links);

            // Restart simulation
            simulation.alpha(1).restart();

            function ticked() {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            }

            // Display metadata
            displayMetadata(metadata);
        }

        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        function showTooltip(event, d) {
            tooltip
                .style('opacity', 1)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .html(`
                    <strong>${d.label}</strong><br>
                    Type: ${d.type}<br>
                    ID: ${d.id}<br>
                    ${d.description ? 'Description: ' + d.description : ''}
                `);
        }

        function hideTooltip() {
            tooltip.style('opacity', 0);
        }

        function nodeClick(event, d) {
            console.log('Node clicked:', d);
            document.getElementById('entityId').value = d.id;
        }

        function resetZoom() {
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity);
        }

        function displayMetadata(metadata) {
            const html = `
                <h3>Graph Metadata</h3>
                <p><strong>Nodes:</strong> ${metadata.node_count}</p>
                <p><strong>Edges:</strong> ${metadata.edge_count}</p>
                <p><strong>Depth:</strong> ${metadata.depth}</p>
                <p><strong>Format:</strong> ${metadata.format}</p>
                ${metadata.truncated ? '<p style="color: orange;"><strong>Note:</strong> Graph was truncated to max_nodes limit</p>' : ''}
            `;
            document.getElementById('metadata').innerHTML = html;
        }

        // Load initial graph on page load
        window.onload = () => {
            loadGraph();
        };
    </script>
</body>
</html>
